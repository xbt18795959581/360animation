<!DOCTYPE HTML>
<HTML>
 <HEAD>
  <TITLE>徐宝婷飞机大战</TITLE>
   <meta charset="utf-8"/>
 </HEAD>

 <BODY>
	<!-- <div>元素的作用：用于完成页面布局 -->
	<div style="margin: 0 auto; width: 480px; height: 650px; background: #323232; text-align: center; vertical-align: middle">
		<!-- 
				主要实用<canvas>元素完成游戏画面
				* 自定义高度和宽度，具有默认高度和宽度
				* Canvas的高度和宽度与div元素一致
		-->
		<canvas id="canvas" width="480" height="650"></canvas>
	</div>
	<script>
		// 一、获取Canvas对象
		// 1. 获取页面中的<canvas>元素
		var canvas = document.getElementById("canvas");
		// 2. 调用getContext('2d')方法，获取画布对象
		var context = canvas.getContext('2d');

		
		// 二、完成游戏初始化
		// 1. 定义出划分的五个阶段
		var START = 0;			
		var STARTING = 1;	
		var RUNNING = 2;	
		var PAUSE = 3;			
		var GAMEOVER = 4;	

		var status = START;

		var width = 480;		
		var height = 650;	

		var life = 3;

		var score = 0;
		function Game(config){
			// 加载的图片
			this.imgs = config.imgs;
			// 图片的宽度
			this.width = config.width;
			// 图片的高度
			this.height = config.height;
			// 定义角标
			this.frame = config.frame;
			// 图片的数量
			this.frames = config.frames;
			// 该方法用于绘制
			this.paint = function(){}
			// 该方法用于动态
			this.step = function(){}
		}

		var bg = new Image();
		bg.src = "img/background.png";

		var SKY = {
			imgs : bg,		// 加载的图片
			width : 480,		// 图片的宽度
			height : 852	// 图片的高度
		}

		function Sky(config){

			Game.call(this, config);

			this.x1 = 0;
			this.y1 = 0;
			this.x2 = 0;
			this.y2 = -this.height;
			this.paint = function(){
				context.drawImage(this.imgs,this.x1,this.y1);
				context.drawImage(this.imgs,this.x2,this.y2);
			}

			this.step = function(){
				this.y1++;
				this.y2++;
				if(this.y1 == this.height){
					this.y1 = -this.height;
				}
				if(this.y2 == this.height){
					this.y2 = -this.height;
				}
			}
		}
		// 创建背景图片的对象
		var sky = new Sky(SKY);
		var copyright = new Image();
		copyright.src = "img/start.png";

		canvas.onclick = function(){
			// 前提条件：当前阶段必须是第一阶段
			if(status == START){
				// 从第一阶段过渡到第二阶段
				status = STARTING;
			}
		}
		// 四、动画过渡阶段
		// 1. 定义一个数组：用于加载动画过渡的4张图片
		var loadings = [];
		loadings[0] = new Image();
		loadings[0].src = "img/game_loading1.png";
		loadings[1] = new Image();
		loadings[1].src = "img/game_loading2.png";
		loadings[2] = new Image();
		loadings[2].src = "img/game_loading3.png";
		loadings[3] = new Image();
		loadings[3].src = "img/game_loading4.png";
		/*********************/

		var LOADING = {
			imgs : loadings,		
			width : 186,				
			height : 38,				
			frame : 0,					
			frames : loadings.length	
		}
		function Loading(config){
			Game.call(this, config);
			
			this.x = 0;
			this.y = height - this.height;

			this.paint = function(){
				context.drawImage(this.imgs[this.frame],this.x,this.y);
			}
			// 定义计数器
			this.count = 0;
			// 该方法用于切换图片
			this.step = function(){
				this.count++;
				if(this.count%2 == 0){
					this.frame++;
				}
				
				if(this.frame == this.frames){
					status = RUNNING;
				}
			}
		}

		var loading = new Loading(LOADING);

		// 五、游戏运行阶段
		// 1. 定义数组：用于加载我方飞机的图片
		var heros = [];
		heros[0] = new Image();
		heros[0].src = "img/hero1.png";
		heros[1] = new Image();
		heros[1].src = "img/hero2.png";
		heros[2] = new Image();
		heros[2].src = "img/hero_blowup_n1.png";
		heros[3] = new Image();
		heros[3].src = "img/hero_blowup_n2.png";
		heros[4] = new Image();
		heros[4].src = "img/hero_blowup_n3.png";
		heros[5] = new Image();
		heros[5].src = "img/hero_blowup_n4.png";
		// 2. 初始化我方飞机的数据内容
		var HERO = {
			imgs : heros,
			width : 99,
			height : 124,
			frame : 0,
			frames : 2
		}
		function Hero(config){
			Game.call(this, config);
			// 定义绘制我方飞机的坐标值
			this.x = width/2 - this.width/2;
			this.y = height - this.height - 50;
			// 该方法用于绘制我方飞机
			this.paint = function(){
				context.drawImage(this.imgs[this.frame],this.x,this.y);
			}
			// 该方法用于我方飞机的动画效果
			this.step = function(){
				if(this.down){
					this.frame++;
					if(this.frame == this.imgs.length){
						// 我方飞机的爆破动画执行完毕后，GAMEOVER
						status =	GAMEOVER;
					}
				}else{
					this.frame++;
					// frame为2，重置为0
					if(this.frame == 2){
						this.frame = 0;
					}
				}
			}
			this.count = 0;
			// 为我方飞机增加射击功能
			this.shoot = function(){
				this.count++;
				if(this.count%5 == 0){
					bullets[bullets.length] = new Bullet(BULLET);
				}
			}
			this.down = false;
			// 处理撞击后的逻辑
			this.bang = function(){
				this.down = true;
				this.frame = this.frames;
			}
			/*************/
		}

		var hero = new Hero(HERO);
		// 4. 为canvas元素绑定onmousemove事件
		canvas.onmousemove = function(event){
			hero.x = event.offsetX - hero.width/2;		//x;
			hero.y = event.offsetY - hero.height/2;		//y;
		}

		// 5. 加载3种敌方飞机的图片
		var e1 = [];		// 代表小飞机
		e1[0] = new Image();
		e1[0].src = "img/enemy1.png";
		e1[1] = new Image();
		e1[1].src = "img/enemy1_down1.png";
		e1[2] = new Image();
		e1[2].src = "img/enemy1_down2.png";
		e1[3] = new Image();
		e1[3].src = "img/enemy1_down3.png";
		e1[4] = new Image();
		e1[4].src = "img/enemy1_down4.png";
		var e2 = [];		// 代表中飞机
		e2[0] = new Image();
		e2[0].src = "img/enemy2.png";
		e2[1] = new Image();
		e2[1].src = "img/enemy2_down1.png";
		e2[2] = new Image();
		e2[2].src = "img/enemy2_down2.png";
		e2[3] = new Image();
		e2[3].src = "img/enemy2_down3.png";
		e2[4] = new Image();
		e2[4].src = "img/enemy2_down4.png";
		var e3 = [];		// 代表大飞机
		e3[0] = new Image();
		e3[0].src = "img/enemy3_n1.png";
		e3[1] = new Image();
		e3[1].src = "img/enemy3_n2.png";
		e3[2] = new Image();
		e3[2].src = "img/enemy3_down1.png";
		e3[3] = new Image();
		e3[3].src = "img/enemy3_down2.png";
		e3[4] = new Image();
		e3[4].src = "img/enemy3_down3.png";
		e3[5] = new Image();
		e3[5].src = "img/enemy3_down4.png";
		e3[6] = new Image();
		e3[6].src = "img/enemy3_down5.png";
		e3[7] = new Image();
		e3[7].src = "img/enemy3_down6.png";
		// 6. 初始化敌方飞机的数据内容
		var E1 = {
			imgs : e1,
			width : 57,
			height : 51,
			frame : 0,
			frames : 1,
			type : 1,		// 表示当前敌方飞机是哪一种
			life : 1			// 表示当前敌方飞机的生命值
		}
		var E2 = {
			imgs : e2,
			width : 69,
			height : 95,
			frame : 0,
			frames : 1,
			type : 2,
			life : 3
		}
		var E3 = {
			imgs : e3,
			width : 169,
			height : 258,
			frame : 0,
			frames : 2,
			type : 3,
			life : 10
		}
		function Enemy(config){
			Game.call(this, config);
			// 补充Game构造器没有的内容
			this.type = config.type;
			this.life = config.life;
			// 定义绘制敌方飞机的坐标值
			this.x = Math.random() * (width - this.width);
			this.y = -this.height;
			// 该方法用于绘制敌方飞机
			this.paint = function(){
				context.drawImage(this.imgs[this.frame],this.x,this.y);
			}
			// 定义一个标识：表示当前敌机允许删除
			this.canDelete = false;
			// 该方法用于切换图片
			this.step = function(){

				if(this.down){
					this.frame++;
					// 判断已经是爆破图片的最后一张，删除当前敌机
					if(this.frame == this.imgs.length){
						// 删除当前敌机
						this.canDelete = true;
					}
				}else{

					 this.frame++;
					 this.frame = this.frame%this.frames;
				}
				
				 // 所有敌方飞机自上而下运动（改变y值 - 增加）
				 switch (this.type){
					case 1:	 // 小飞机
						this.y += 5;
						break;
					case 2: // 中飞机
						this.y += 3;
						break;
					case 3: // 大飞机
						this.y++;
						break;
				 }
			}
			// 该方法用于判断当前敌机是否飞出画面
			this.isOut = function(){
				// 敌机的坐标值y值 >= 画布的高度
				return this.y >= height;
			}
			// 该方法用于检查当前敌机是否被撞击（我方飞机或子弹）
			this.checkHit = function(compent){	
				// 使用参数表示我方飞机和子弹
				// 返回true表示被撞击，否则没被撞击
				return compent.x + compent.width/2 > this.x &&
				compent.y + compent.height/2 < this.y + this.height &&
				compent.x + compent.width/2 < this.x + this.width &&
				compent.y + compent.height/2 > this.y
			}
			this.down = false;	// 不是爆破
			// 该方法用于当前敌机被撞击后的逻辑
			this.bang = function(){
				// 1. 将当前敌机的生命值 -1
				this.life--;
				// 2. 判断当前敌机的生命值是否为 0
				if(this.life == 0){
					// 进入到爆破动画阶段
					this.down = true;
					this.frame = this.frames;
				}
			}
		}

		// 定义一个数组用于存储所有的敌方飞机
		var enemies = [];

		// 定义一个函数：用于创建敌方飞机（小中大）
		function enemiesEnter(){
			 var num = Math.floor(Math.random() * 100);
			 // 根据随机值做判断创建小飞机、中飞机及大飞机
			 if(num <= 7){	
				enemies[enemies.length] = new Enemy(E1);
			 }else if(num == 8){
				enemies[enemies.length] = new Enemy(E2);
			 }else if(num == 9){
				if(enemies[0].type != 3){	
					enemies.splice(0,1,new Enemy(E3));
				}
			 }
		}
		function enemiesPaint(){
			for(var i=0;i<enemies.length;i++){
				enemies[i].paint();
			}
		}
		function enemiesStep(){
			for(var i=0;i<enemies.length;i++){
				enemies[i].step();
			}
		}
		// 定义一个函数：如果敌方飞机飞出画面，将其删除
		function enemiesDel(){
			// 判断敌方飞机是否飞出画面
			for(var i=0;i<enemies.length;i++){
				if(enemies[i].isOut() || enemies[i].canDelete){
					// 说明当前的敌机飞出画面，删除
					enemies.splice(i,1);
				}
			}
		}

		// 8. 加载子弹的图片
		var zidan = new Image();
		zidan.src = "img/bullet1.png";
		// 9. 初始化子弹的数据内容
		var BULLET = {
			imgs : zidan,
			width : 9,
			height : 21
		}
		function Bullet(config){
			Game.call(this,config);
			this.x = hero.x + hero.width/2 - this.width/2;
			this.y = hero.y - this.height;
			this.canDelete = false;
			this.paint = function(){
				context.drawImage(this.imgs,this.x,this.y);
			}
			this.step = function(){
				this.y -= 10;
			},
			this.isOut = function(){
				return this.y + this.height < 0;
			}
		}
		var bullets = [];
		// 定义一个函数：用于绘制所有子弹
		function bulletsPaint(){
			for(var i=0;i<bullets.length;i++){
				bullets[i].paint();
			}
		}
		// 定义一个函数：用于控制所有子弹运动
		function bulletsStep(){
			for(var i=0;i<bullets.length;i++){
				bullets[i].step();
			}
		}
		// 定义一个函数：如果子弹飞出画面，将其删除
		function bulletsDel(){
			for(var i=0;i<bullets.length;i++){
				if(bullets[i].isOut() || bullets[i].canDelete){
					bullets.splice(i,1);
				}
			}
		}

		// 定义一个函数：专门用于检查敌机是否被撞击（我方飞机和子弹）
		function checkHit(){
			for(var i=0;i<enemies.length;i++){
				// 我方飞机撞击敌方飞机
				if(enemies[i].checkHit(hero)){
					// 处理敌机被撞击后的逻辑
					enemies[i].bang();
					// 处理我方飞机杯撞击后的逻辑
					hero.bang();
				}
				// 子弹撞击敌方飞机
				for(var j=0;j<bullets.length;j++){
					if(enemies[i].checkHit(bullets[j])){
						// 处理敌机被撞击后的逻辑
						enemies[i].bang();
						// 子弹被撞击后的逻辑
						bullets[j].canDelete = true;
					}
				}
			}
		}
		setInterval(function(){
			sky.paint();
			sky.step();
			switch (parseInt(status)){
				case START :
					// 绘制游戏的LOGO图片
					context.drawImage(copyright,15,0);
					break;
				case STARTING :
					loading.paint();
					loading.step();
					break;
				case RUNNING :
					hero.paint();
					hero.step();

					enemiesEnter();
					enemiesPaint();
					enemiesStep();
					enemiesDel();

					hero.shoot();
					bulletsPaint();
					bulletsStep();

					checkHit();
					break;
				case PAUSE :
					break;
				case GAMEOVER :
					break;
			}
		},100);



	</script>
 </BODY>
</HTML>
